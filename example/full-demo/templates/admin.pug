doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    title #{name} Admin
  body
    header
      h1 #{name} Admin
      p
        span#storage Storage: ...
        |  &mdash;
        span#count 0 #{namePlural}

    main
      section
        h2 All #{namePluralCap}
        table
          thead
            tr
              th ID
              each field in fields
                th #{field.capitalized}
              th Created
              th Actions
          tbody#items-body
            tr
              td(colspan=fields.length + 3 style="text-align:center") Loading...

      section
        h2#form-title Create #{name}
        form#create-form
          each field in fields
            div(style="margin-bottom:1rem")
              if field.type === 'boolean'
                label
                  input(type="checkbox" id=field.name name=field.name)
                  |  #{field.capitalized}
              else
                label(for=field.name) #{field.capitalized}
                br
                if field.type === 'number'
                  input(type="number" id=field.name name=field.name required step="any" style="width:100%")
                else
                  input(type="text" id=field.name name=field.name required style="width:100%")
          br
          button#submit-btn(type="submit") Create
          |
          button#cancel-btn(type="button" style="display:none") Cancel

    footer
      p Generated by SCG on #{timestamp}

    script.
      var API = '/#{namePlural}';
      var FIELDS = !{JSON.stringify(fields.map(function(f){return {name:f.name,type:f.type,cap:f.capitalized}}))};
      var ENTITY = '#{name}';
      var COLS = FIELDS.length + 3;
      var editingId = null;

      function escapeHtml(s) {
        var d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
      }

      function renderRow(item) {
        var cells = FIELDS.map(function(f) {
          var v = item[f.name];
          if (f.type === 'boolean') return '<td>' + (v ? 'Yes' : 'No') + '</td>';
          return '<td>' + escapeHtml(String(v)) + '</td>';
        }).join('');
        return '<tr>' +
          '<td><code>' + item.id.substring(0, 8) + '</code></td>' +
          cells +
          '<td>' + new Date(item.createdAt).toLocaleDateString() + '</td>' +
          '<td>' +
          '<button onclick="editItem(\'' + item.id + '\')">Edit</button> ' +
          '<button onclick="deleteItem(\'' + item.id + '\')">Delete</button>' +
          '</td></tr>';
      }

      function loadItems() {
        fetch(API).then(function(r) { return r.json(); }).then(function(items) {
          document.getElementById('count').textContent = items.length + ' #{namePlural}';
          var tbody = document.getElementById('items-body');
          if (items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="' + COLS + '" style="text-align:center;color:#999">No #{namePlural} yet. Create one below.</td></tr>';
            return;
          }
          tbody.innerHTML = items.map(renderRow).join('');
        });
      }

      function loadInfo() {
        fetch('/').then(function(r) { return r.json(); }).then(function(info) {
          document.getElementById('storage').textContent = 'Storage: ' + info.storage;
        });
      }

      function getFormData() {
        var body = {};
        FIELDS.forEach(function(f) {
          var el = document.getElementById(f.name);
          if (f.type === 'boolean') body[f.name] = el.checked;
          else if (f.type === 'number') body[f.name] = Number(el.value);
          else body[f.name] = el.value;
        });
        return body;
      }

      function cancelEdit() {
        editingId = null;
        document.getElementById('create-form').reset();
        document.getElementById('form-title').textContent = 'Create ' + ENTITY;
        document.getElementById('submit-btn').textContent = 'Create';
        document.getElementById('cancel-btn').style.display = 'none';
      }

      document.getElementById('create-form').addEventListener('submit', function(e) {
        e.preventDefault();
        var body = getFormData();
        var url = editingId ? API + '/' + editingId : API;
        var method = editingId ? 'PUT' : 'POST';
        fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        }).then(function() {
          cancelEdit();
          loadItems();
        });
      });

      document.getElementById('cancel-btn').addEventListener('click', cancelEdit);

      window.editItem = function(id) {
        fetch(API + '/' + id).then(function(r) { return r.json(); }).then(function(item) {
          FIELDS.forEach(function(f) {
            var el = document.getElementById(f.name);
            if (f.type === 'boolean') el.checked = item[f.name];
            else el.value = item[f.name];
          });
          editingId = id;
          document.getElementById('form-title').textContent = 'Edit ' + ENTITY;
          document.getElementById('submit-btn').textContent = 'Update';
          document.getElementById('cancel-btn').style.display = 'inline';
        });
      };

      window.deleteItem = function(id) {
        if (!confirm('Delete this ' + ENTITY.toLowerCase() + '?')) return;
        fetch(API + '/' + id, { method: 'DELETE' }).then(function() { loadItems(); });
      };

      loadInfo();
      loadItems();
